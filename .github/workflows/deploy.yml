name: Deploy to Koyeb

on:
  push:
    branches:
      - main  # Sesuaikan dengan branch Anda
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Koyeb CLI
        run: |
          # Download dan install Koyeb CLI
          curl -fsSL https://cli.koyeb.com/install.sh | sh
          
          # Verifikasi instalasi
          ls -la $HOME/.koyeb/bin/ || echo "Koyeb CLI directory not found"
          
          # Tambahkan ke PATH untuk step selanjutnya
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Verify CLI Installation
        run: |
          # Tunggu sebentar untuk memastikan PATH ter-update
          export PATH="$HOME/.koyeb/bin:$PATH"
          
          # Cek apakah binary ada
          if [ -f "$HOME/.koyeb/bin/koyeb" ]; then
            echo "‚úÖ Koyeb CLI found at $HOME/.koyeb/bin/koyeb"
            $HOME/.koyeb/bin/koyeb version
          else
            echo "‚ùå Koyeb CLI not found"
            exit 1
          fi

      - name: List Services
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          export PATH="$HOME/.koyeb/bin:$PATH"
          
          echo "================================================"
          echo "üìã Listing all services in your Koyeb account:"
          echo "================================================"
          
          $HOME/.koyeb/bin/koyeb service list || {
            echo "‚ùå Failed to list services"
            echo "Please check your KOYEB_API_TOKEN"
            exit 1
          }
          
          echo ""
          echo "================================================"
          echo "‚ö†Ô∏è  IMPORTANT: Check the service list above"
          echo "================================================"
          echo "Update the workflow with correct APP_NAME and SERVICE_NAME"

      - name: Trigger Redeploy
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          export PATH="$HOME/.koyeb/bin:$PATH"
          
          # ‚ö†Ô∏è GANTI NILAI INI dengan nama yang benar dari output di atas
          APP_NAME="kuad"
          SERVICE_NAME="ku-ad"
          
          echo "================================================"
          echo "üöÄ Triggering redeploy..."
          echo "================================================"
          echo "App: $APP_NAME"
          echo "Service: $SERVICE_NAME"
          echo ""
          
          $HOME/.koyeb/bin/koyeb service redeploy $APP_NAME/$SERVICE_NAME || {
            echo "‚ùå Redeploy failed"
            echo "Please verify APP_NAME and SERVICE_NAME are correct"
            exit 1
          }
          
          echo ""
          echo "‚úÖ Redeploy triggered successfully!"
          echo "Check status at: https://app.koyeb.com"

      - name: Deployment Success
        if: success()
        run: |
          echo ""
          echo "================================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "================================================"
          echo "Your Spring Boot app is being deployed to Koyeb"
          echo "Monitor progress at: https://app.koyeb.com"

      - name: Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "================================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "================================================"
          echo "Common issues:"
          echo "1. Invalid KOYEB_API_TOKEN - check GitHub Secrets"
          echo "2. Wrong APP_NAME or SERVICE_NAME"
          echo "3. Service not found in Koyeb"
          echo ""
          echo "Please check the logs above for details"