name: Deploy to Koyeb

on:
  push:
    branches:
      - main  # Sesuaikan dengan branch Anda
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://cli.koyeb.com/install.sh | sh
          echo "$HOME/.koyeb/bin" >> $GITHUB_PATH

      - name: Get Service Info
        id: service-info
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # List semua services untuk debugging
          echo "Listing all services..."
          $HOME/.koyeb/bin/koyeb service list
          
          # Simpan output untuk step selanjutnya
          echo "Please check the service list above and update the workflow"

      - name: Trigger Redeploy
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          # GANTI NILAI INI dengan nama app/service Anda yang benar
          # Format: APP_NAME/SERVICE_NAME
          # Contoh: my-app/my-service
          
          APP_NAME=kuad
          SERVICE_NAME=ku-ad
          
          echo "Triggering redeploy for $APP_NAME/$SERVICE_NAME..."
          $HOME/.koyeb/bin/koyeb service redeploy $APP_NAME/$SERVICE_NAME
          
          echo "✅ Redeploy triggered successfully!"
          echo "Check deployment status at: https://app.koyeb.com"

      - name: Deployment Complete
        if: success()
        run: |
          echo "================================================"
          echo "✅ Deployment workflow completed successfully!"
          echo "================================================"
          echo "Next steps:"
          echo "1. Go to https://app.koyeb.com"
          echo "2. Check your service status"
          echo "3. Wait for the deployment to complete"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "================================================"
          echo "❌ Deployment workflow failed!"
          echo "================================================"
          echo "Troubleshooting:"
          echo "1. Check if KOYEB_API_TOKEN is set correctly in GitHub Secrets"
          echo "2. Verify APP_NAME and SERVICE_NAME are correct"
          echo "3. Check the logs above for specific errors"