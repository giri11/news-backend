name: Deploy to Koyeb

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger Redeploy via Koyeb API
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          echo "================================================"
          echo "üöÄ Deploying to Koyeb..."
          echo "================================================"
          
          # OPSI 1: Hardcode Service ID (lebih simple)
          # Ganti SERVICE_ID dengan ID service Anda
          # SERVICE_ID="your-service-id-here"
          
          # OPSI 2: Dynamic - cari service ID by name
          echo "Getting service ID for 'ku-ad'..."
          services=$(curl -s -H "Authorization: Bearer $KOYEB_TOKEN" \
            https://app.koyeb.com/v1/services)
          
          SERVICE_ID=$(echo "$services" | jq -r '.services[] | select(.name == "ku-ad") | .id')
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "null" ]; then
            echo "‚ùå Service 'ku-ad' not found!"
            echo "Available services:"
            echo "$services" | jq -r '.services[] | "\(.name) - \(.id)"'
            exit 1
          fi
          
          echo "‚úÖ Found service ID: $SERVICE_ID"
          echo ""
          
          # Trigger redeploy
          echo "Triggering redeploy..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $KOYEB_TOKEN" \
            -H "Content-Type: application/json" \
            https://app.koyeb.com/v1/services/$SERVICE_ID/redeploy)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo ""
            echo "‚úÖ Deployment triggered successfully!"
            echo "Monitor at: https://app.koyeb.com/apps/kuad/services/ku-ad"
          else
            echo ""
            echo "‚ùå Deployment failed with status $http_code"
            exit 1
          fi